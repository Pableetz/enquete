name: Enquête policière SuperPrix

on: 
  push:

jobs:
  policier-scene:
    runs-on: ubuntu-latest
    outputs:
      empreinte: "empreinte trouvée sur la caisse"
    steps:
      - name: Observation de la scène
        run: echo "Le policier examine la caisse enregistreuse"
      - name: Prélèvement d’empreinte
        run: echo "Empreinte prélevée sur la caisse"

  policier-video:
    runs-on: ubuntu-latest
    outputs:
      video: ${{ steps.get_video.outputs.resultat }}
    steps:
      - name: Récupération vidéo
        id: get_video
        run: echo "resultat=Séquence vidéo 22h15-22h45 récupérée" >> $GITHUB_OUTPUT

  detective:
    runs-on: ubuntu-latest
    needs: [policier-scene, policier-video]
    outputs:
      rapport: ${{ steps.rapport-final.outputs.conclusion }}
      lieu_arrestation: ${{ steps.rapport-final.outputs.lieu }}
      autorisation_arrestation: ${{ steps.rapport-final.outputs.autorisation }}
    steps:
      - name: Affichage des indices
        run: |
          echo "Indice empreinte : ${{ needs.policier-scene.outputs.empreinte }}"
          echo "Indice vidéo : ${{ needs.policier-video.outputs.video }}"

      - name: Analyse des indices
        run: |
          echo "ANALYSE_EMPREINTE=Empreinte correspond à un suspect connu" >> $GITHUB_ENV
          echo "ANALYSE_VIDEO=Suspect identifié sur la vidéo à 22h30" >> $GITHUB_ENV

      - name: Rapport final
        id: rapport-final
        run: |
          echo "conclusion=${ANALYSE_EMPREINTE}, ${ANALYSE_VIDEO}, suspect identifié" >> $GITHUB_OUTPUT
          echo "lieu=42 Avenue du Commerce, Supermarché SuperPrix" >> $GITHUB_OUTPUT
          echo "autorisation=true" >> $GITHUB_OUTPUT

  police:
    runs-on: ubuntu-latest
    needs: detective
    steps:
      - name: Lecture du rapport du détective
        run: |
          echo "📝 Rapport : ${{ needs.detective.outputs.rapport }}"
          echo "📍 Lieu : ${{ needs.detective.outputs.lieu_arrestation }}"
          echo "✅ Autorisation : ${{ needs.detective.outputs.autorisation_arrestation }}"

      - name: Vérification de l’autorisation
        if: needs.detective.outputs.autorisation_arrestation != 'true'
        run: echo "🚫 Pas d'autorisation – enquête classée sans suite."

      - name: Intervention
        if: needs.detective.outputs.autorisation_arrestation == 'true'
        run: echo "🚓 Intervention en cours au 42 Avenue du Commerce"
